<div class="product-card">
    <a href="{{ url_for('product_detail', product_id=product.id) }}">
        <div class="product-image-wrapper">
            {# --- LIGNE MODIFIÉE CI-DESSOUS --- #}
            {# On utilise 'product.image_url' en priorité. S'il n'existe pas, on se rabat sur 'product.image_file'. #}
            {# Cela rend la carte compatible avec les recommandations ET les autres pages. #}
            <img src="{{ product.image_url or product.image_file }}" alt="{{ product.name }}" loading="lazy" decoding="async">
        </div>
        <h3>{{ product.name }}</h3>
    </a>

    <div class="product-card-info">
        <p class="brand">Marque : {{ product.brand or 'N/A' }}</p>
    </div>
    
    <div class="product-card-actions" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; gap: 5px;">
        <a href="{{ url_for('product_detail', product_id=product.id) }}" class="btn btn-details btn-sm" style="flex-grow: 1;">Voir Détails</a>
        
        {% if current_user.is_authenticated %}
            {% if not current_user.is_admin %} {# Utilisateur connecté ET n'est PAS admin #}
                <form action="{{ url_for('toggle_favorite', product_id=product.id) }}" method="POST" style="display: inline-block; flex-shrink: 0;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    {% if product.id in favorite_product_ids %}
                        <button type="submit" class="btn btn-sm btn-danger" title="Retirer des favoris">
                            <i class="fas fa-heart"></i> {# Coeur plein #}
                        </button>
                    {% else %}
                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Ajouter aux favoris">
                            <i class="far fa-heart"></i> {# Coeur vide #}
                        </button>
                    {% endif %}
                </form>
            {% endif %} {# Fin de la condition 'not current_user.is_admin' #}
        {% else %} {# Utilisateur NON connecté #}
            <a href="{{ url_for('login', next=request.url, reason='favorites') }}" class="btn btn-sm btn-outline-danger" title="Connectez-vous pour ajouter aux favoris">
                <i class="far fa-heart"></i> {# Coeur vide #}
            </a>
        {% endif %}
    </div>
</div>
