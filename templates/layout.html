<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{% block title %}Luxury Akran{% endblock %}</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

<!-- Menu mobile et son overlay -->
<div id="mobile-menu-overlay"></div>
<div id="mobile-menu">
    <div class="mobile-menu-header">
        {% if current_user.is_authenticated %}
        <div class="user-profile-actions">
            <div class="user-avatar" title="{{ current_user.username }}">{{ current_user.initials }}</div>
            <span class="mobile-menu-username">{{ current_user.username }}</span>
        </div>
        {% else %}
        <div></div> <!-- Pour l'alignement -->
        {% endif %}
        <button id="mobile-menu-close" aria-label="Fermer le menu"><i class="fas fa-times"></i></button>
    </div>
    <div class="mobile-menu-content">
        <form action="{{ url_for('products_list') }}" method="get" class="search-form">
            <input type="search" name="query" placeholder="Rechercher un article..." value="{{ request.args.get('query', '') }}">
            <button type="submit"><i class="fas fa-search"></i></button>
        </form>
        <nav class="mobile-main-nav">
            <ul>
                <li><a href="{{ url_for('index') }}">Accueil</a></li>
                <li><a href="{{ url_for('products_list') }}">Produits</a></li>
                <li><a href="#contact-section" class="mobile-menu-contact-link">Contact</a></li>
            </ul>
        </nav>
    </div>
    <div class="mobile-menu-footer">
        {% if current_user.is_authenticated %}
            {% if not current_user.is_admin %}
                <a href="{{ url_for('my_favorites') }}"><i class="fas fa-star"></i> Favoris</a>
            {% endif %}
            <a href="{{ url_for('logout') }}">Déconnexion</a>
        {% else %}
            <a href="{{ url_for('login') }}" class="btn btn-login-mobile">Connexion</a>
            <a href="{{ url_for('register') }}" class="btn btn-register-mobile">S'inscrire</a>
        {% endif %}
    </div>
</div>

<!-- Header pour PC avec le bouton hamburger pour mobile -->
<header>
    <div class="container nav-container">
        <a href="{{ url_for('index') }}" class="logo">LUXURY AKRAN</a>
        <nav>
            <ul>
                <li><a href="{{ url_for('index') }}" class="{{ 'active' if request.endpoint == 'index' else '' }}">Accueil</a></li>
                <li><a href="{{ url_for('products_list') }}" class="{{ 'active' if request.endpoint == 'products_list' or request.endpoint == 'product_detail' or request.endpoint == 'api_products_filter' else '' }}">Produits</a></li>
                <li><a href="#contact-section">Contact</a></li>
            </ul>
        </nav>
        <div class="header-actions">
            <form action="{{ url_for('products_list') }}" method="get" class="search-form">
                <input type="search" id="headerSearchInput" name="query" placeholder="Rechercher un article..." value="{{ request.args.get('query', '') }}">
                <button type="submit"><i class="fas fa-search"></i></button>
            </form>
            {% if current_user.is_authenticated %}
                {% if not current_user.is_admin %}
                    <a href="{{ url_for('my_favorites') }}" class="nav-button" title="Mes Favoris"><i class="fas fa-heart"></i> Favoris</a>
                {% endif %}
                {% if current_user.is_admin %}
                    <a href="{{ url_for('admin_dashboard') }}" class="nav-button admin-link">Admin</a>
                {% endif %}
                <div class="user-profile-actions">
                    <div class="user-avatar" title="{{ current_user.username }}">{{ current_user.initials }}</div>
                    <a href="{{ url_for('logout') }}" class="nav-button">Déconnexion</a>
                </div>
            {% else %}
                <a href="{{ url_for('login') }}" class="nav-button">Connexion</a>
                <a href="{{ url_for('register') }}" class="nav-button btn-primary-outline">S'inscrire</a>
            {% endif %}
        </div>
        <button id="mobile-menu-toggle" aria-label="Ouvrir le menu"><i class="fas fa-bars"></i></button>
    </div>
</header>

<main>{% block content %}{% endblock %}</main>

<footer id="contact-section">
    <div class="container">
        <p>© {{ now.year }} Luxury Akran. Tous droits réservés.</p>
        <p>Contactez-nous : <i class="fab fa-whatsapp"></i> <a href="https://wa.me/{{ config.WHATSAPP_NUMBER }}" target="_blank">WhatsApp</a> | Email: <a href="mailto:info@luxuryakran.com">info@luxuryakran.com</a> (exemple)</p>
        <p><a href="{{ url_for('index') }}">Accueil</a> | <a href="{{ url_for('products_list') }}">Produits</a> | <a href="#">Politique de confidentialité (exemple)</a></p>
    </div>
</footer>

<!-- Scripts -->
<script>
    const flaskGlobalIsAuthenticated = {{ current_user.is_authenticated|tojson }};
    const flaskGlobalCsrfToken = "{{ csrf_token() }}";
    const flaskGlobalToggleFavoriteUrl = "{{ url_for('toggle_favorite', product_id=0) }}";
    const flaskGlobalIsAdmin = {{ current_user.is_admin|tojson if current_user.is_authenticated else false|tojson }};
    const flaskGlobalLoginUrl = "{{ url_for('login') }}";
</script>

{% block scripts %}{% endblock %}

<!-- Script principal avec toutes les logiques (toast, favoris, menu mobile) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- RESTAURATION : Logique pour les notifications "Toast" ---
    window.showToast = function(message, category = 'info', duration = 5000) {
        const container = document.getElementById('toast-container');
        if (!container) {
            console.error("Toast container not found!");
            return;
        }
        const toast = document.createElement('div');
        toast.className = `toast toast-${category}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => { toast.classList.add('show'); }, 10);
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, duration);
    }

    // --- RESTAURATION : Logique AJAX pour les favoris ---
    async function handleFavoriteToggle(event) {
        event.preventDefault(); 
        const form = event.target.closest('form');
        if (!form) return;
        const button = form.querySelector('button[type="submit"]');
        const icon = button.querySelector('i');
        
        button.disabled = true;
        const originalIconClass = icon.className;
        icon.className = 'fas fa-spinner fa-spin';

        try {
            const formData = new FormData(form);
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.message || 'Erreur serveur');
            
            if (data.status === 'success') {
                if (data.is_favorited) {
                    button.classList.remove('btn-outline-danger');
                    button.classList.add('btn-danger');
                    button.title = "Retirer des favoris";
                    icon.className = 'fas fa-heart';
                } else {
                    button.classList.remove('btn-danger');
                    button.classList.add('btn-outline-danger');
                    button.title = "Ajouter aux favoris";
                    icon.className = 'far fa-heart';
                }
                window.showToast(data.message, data.is_favorited ? 'success' : 'info');
                if (window.location.pathname === '/my_favorites' && !data.is_favorited) {
                    form.closest('.product-card')?.remove();
                }
            } else {
                icon.className = originalIconClass;
                window.showToast(data.message, 'danger');
            }
        } catch (error) {
            console.error('Erreur AJAX:', error);
            icon.className = originalIconClass;
            window.showToast(error.message, 'danger');
        } finally {
            button.disabled = false;
        }
    }
    
    document.body.addEventListener('submit', function(event) {
        if (event.target.matches('form[action*="/toggle_favorite/"]')) {
            handleFavoriteToggle(event);
        }
    });

    // --- CONSERVATION : Logique du menu mobile ---
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const mobileMenuClose = document.getElementById('mobile-menu-close');
    const mobileMenu = document.getElementById('mobile-menu');
    const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
    const contactLink = document.querySelector('.mobile-menu-contact-link');

    function openMenu() { mobileMenu.classList.add('open'); mobileMenuOverlay.classList.add('open'); document.body.style.overflow = 'hidden'; }
    function closeMenu() { mobileMenu.classList.remove('open'); mobileMenuOverlay.classList.remove('open'); document.body.style.overflow = ''; }

    if (mobileMenuToggle) mobileMenuToggle.addEventListener('click', openMenu);
    if (mobileMenuClose) mobileMenuClose.addEventListener('click', closeMenu);
    if (mobileMenuOverlay) mobileMenuOverlay.addEventListener('click', closeMenu);
    if (contactLink) { contactLink.addEventListener('click', (e) => { e.preventDefault(); closeMenu(); setTimeout(() => { document.getElementById('contact-section').scrollIntoView({ behavior: 'smooth' }); }, 300); }); }
});
</script>

<!-- Script pour transformer les messages flash du serveur en toasts -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof window.showToast === 'function') {
                {% for category, message in messages %}
                    window.showToast({{ message|tojson }}, {{ category|tojson }});
                {% endfor %}
            }
        });
    </script>
    {% endif %}
{% endwith %}

<!-- Conteneur pour les notifications toast -->
<div id="toast-container"></div>
</body>
</html>